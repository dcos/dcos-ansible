---
- name: DC/OS Requirements
  hosts: all:!agents_windows
  become: true
  tasks:
    - include_role:
        name: dcos_requirements
- name: Set open checksum and url
  hosts: localhost
  tasks:
  - set_fact:
      test_initial_download: "https://downloads.dcos.io/dcos/testing/master/commit/8d77deb4e5523e49729940485c31ce2c56bf6c43/dcos_generate_config.sh"
      test_initial_download_checksum: ""
      test_initial_version: "2.1.0-dev"
      test_initial_download_win: "https://downloads.dcos.io/dcos/testing/master/commit/8d77deb4e5523e49729940485c31ce2c56bf6c43/windows/dcos_generate_config_win.ee.sh"
      test_upgrade_download: "https://downloads.dcos.io/dcos/testing/master/dcos_generate_config.sh"
      test_upgrade_download_checksum: ""
      test_upgrade_version: "2.1.0-master"
      test_upgrade_download_win: "https://downloads.dcos.io/dcos/testing/master/windows/dcos_generate_config_win.sh"
    when: not dcos['enterprise_dcos']
  - set_fact:
      test_initial_download: "https://downloads.mesosphere.com/dcos-enterprise/testing/master/commit/2e5060be4bf23e1dc66f6bf2108cb0c84cb258f7/dcos_generate_config.ee.sh"
      test_initial_download_checksum: ""
      test_initial_version: "2.1.0-dev"
      test_initial_download_win: "https://downloads.mesosphere.com/dcos-enterprise/testing/master/commit/2e5060be4bf23e1dc66f6bf2108cb0c84cb258f7/windows/dcos_generate_config_win.ee.sh"
      test_upgrade_download: "https://downloads.mesosphere.com/dcos-enterprise/testing/master/dcos_generate_config.ee.sh"
      test_upgrade_download_checksum: ""
      test_upgrade_version: "2.1.0-master"
      test_upgrade_download_win: "https://downloads.mesosphere.com/dcos-enterprise/testing/master/windows/dcos_generate_config_win.ee.sh"
    when: dcos['enterprise_dcos']


- name: "Setup and configure BOOTSTRAP nodes"
  hosts: bootstraps
  become: true
  tasks:
    - include_role:
        name: dcos_bootstrap
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_initial_download }}"
      download_checksum: "{{ hostvars['localhost'].test_initial_download_checksum }}"
      download_win: "{{ hostvars['localhost'].test_initial_download_win }}"
      version: "{{ hostvars['localhost'].test_initial_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]
        enable_windows_agents: true

- name: "Setup and configure MASTER nodes"
  hosts: masters
  serial: 1
  become: true
  tasks:
    - include_role:
        name: dcos_master
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_initial_download }}"
      download_checksum: "{{ hostvars['localhost'].test_initial_download_checksum }}"
      version: "{{ hostvars['localhost'].test_initial_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]

- name: "Setup and configure AGENT nodes"
  hosts: agents
  become: true
  tasks:
    - include_role:
        name: dcos_agent
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_initial_download }}"
      download_checksum: "{{ hostvars['localhost'].test_initial_download_checksum }}"
      version: "{{ hostvars['localhost'].test_initial_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]

- name: "Setup and configure WINDOWS AGENT nodes"
  hosts: agents_windows
  tasks:
    - include_role:
        name: dcos_agent_windows
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_initial_download }}"
      download_checksum: "{{ hostvars['localhost'].test_initial_download_checksum }}"
      download_win: "{{ hostvars['localhost'].test_initial_download_win }}"
      version: "{{ hostvars['localhost'].test_initial_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]
        enable_windows_agents: true


- name: "WAIT for the cluster to stabilise before upgrade"
  hosts: localhost
  tasks:
    - name: WAIT for the cluster to stabilise before upgrade
      pause:
        minutes: 1

- name: Collect DC/OS versions
  hosts: all
  tasks:
    - name: Collect DC/OS versions
      setup:

- name: "Upgrade and configure BOOTSTRAP nodes"
  hosts: bootstraps
  become: true
  tasks:
    - include_role:
        name: dcos_bootstrap
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_upgrade_download }}"
      download_checksum: "{{ hostvars['localhost'].test_upgrade_download_checksum }}"
      download_win: "{{ hostvars['localhost'].test_upgrade_download_win }}"
      version: "{{ hostvars['localhost'].test_upgrade_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]
        enable_windows_agents: true

- name: "Upgrade and configure MASTER nodes"
  hosts: masters
  serial: 1
  become: true
  tasks:
    - include_role:
        name: dcos_master
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_upgrade_download }}"
      download_checksum: "{{ hostvars['localhost'].test_upgrade_download_checksum }}"
      download_win: "{{ hostvars['localhost'].test_upgrade_download_win }}"
      version: "{{ hostvars['localhost'].test_upgrade_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]
        enable_windows_agents: true

- name: "Upgrade and configure AGENT nodes"
  hosts: agents
  become: true
  tasks:
    - include_role:
        name: dcos_agent
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_upgrade_download }}"
      download_checksum: "{{ hostvars['localhost'].test_upgrade_download_checksum }}"
      download_win: "{{ hostvars['localhost'].test_upgrade_download_win }}"
      version: "{{ hostvars['localhost'].test_upgrade_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]
        enable_windows_agents: true

- name: "Upgrade and configure WINDOWS AGENT nodes"
  hosts: agents_windows
  tasks:
    - include_role:
        name: dcos_agent_windows
  vars:
    dcos:
      download: "{{ hostvars['localhost'].test_upgrade_download }}"
      download_checksum: "{{ hostvars['localhost'].test_upgrade_download_checksum }}"
      download_win: "{{ hostvars['localhost'].test_upgrade_download_win }}"
      version: "{{ hostvars['localhost'].test_upgrade_version }}"
      config:
        bootstrap_url: "http://{{ hostvars[groups['bootstraps'][0]].ansible_facts.default_ipv4.address }}:8080"
        master_list: ["{{ hostvars[groups['masters'][0]].ansible_facts.default_ipv4.address }}"]
        enable_windows_agents: true
